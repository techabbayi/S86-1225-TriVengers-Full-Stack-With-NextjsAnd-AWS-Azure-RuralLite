// Prisma Schema for RuralLite Learning Platform
// Database: PostgreSQL

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// User model - Students and Teachers
model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  name      String
  role      UserRole  @default(STUDENT)
  password  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Relations
  progress    Progress[]
  quizResults QuizResult[]
  notes       Note[]
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

// Lesson model - Educational content
model Lesson {
  id           Int       @id @default(autoincrement())
  title        String
  description  String
  content      String    // Markdown or HTML content
  subject      String
  grade        Int
  difficulty   Difficulty @default(BEGINNER)
  isOffline    Boolean   @default(true)
  mediaUrl     String?   // Optional media assets
  thumbnailUrl String?
  downloadSize Int?      // Size in KB for offline caching
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  progress     Progress[]
  quizzes      Quiz[]
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// Quiz model - Assessments
model Quiz {
  id           Int       @id @default(autoincrement())
  lessonId     Int
  title        String
  description  String?
  passingScore Int       @default(70)
  timeLimit    Int?      // Time in minutes
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  lesson       Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions    Question[]
  results      QuizResult[]
  
  @@index([lessonId])
}

// Question model - Quiz questions
model Question {
  id            Int      @id @default(autoincrement())
  quizId        Int
  question      String
  options       String[] // Array of options
  correctAnswer String
  points        Int      @default(1)
  orderIndex    Int      @default(0)
  
  // Relations
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  @@index([quizId])
}

// Quiz Result model - Student quiz attempts
model QuizResult {
  id          Int       @id @default(autoincrement())
  userId      Int
  quizId      Int
  score       Int
  completedAt DateTime  @default(now())
  syncedAt    DateTime? // When synced to cloud
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers     Answer[]
  
  @@index([userId])
  @@index([quizId])
}

// Answer model - Student's answers
model Answer {
  id           Int        @id @default(autoincrement())
  quizResultId Int
  questionId   Int
  selected     String
  isCorrect    Boolean
  
  // Relations
  quizResult   QuizResult @relation(fields: [quizResultId], references: [id], onDelete: Cascade)
  
  @@index([quizResultId])
}

// Progress tracking model
model Progress {
  id           Int       @id @default(autoincrement())
  userId       Int
  lessonId     Int
  completed    Boolean   @default(false)
  progress     Int       @default(0) // Percentage
  lastAccessed DateTime  @default(now())
  syncedAt     DateTime? // When synced to cloud
  
  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson       Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

// Notes model - Student notes
model Note {
  id        Int       @id @default(autoincrement())
  userId    Int
  title     String
  content   String
  tags      String[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  syncedAt  DateTime? // When synced to cloud
  
  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Product & Order models for transaction demos and benchmarking
model Product {
  id        Int     @id @default(autoincrement())
  name      String
  sku       String  @unique
  price     Float
  stock     Int     @default(0)
  createdAt DateTime @default(now())

  orderItems OrderItem[]

  @@index([name])
}

model Order {
  id        Int      @id @default(autoincrement())
  userId    Int
  total     Float
  status    String   @default("PENDING")
  createdAt DateTime @default(now())

  items     OrderItem[]

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        Int   @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  price     Float

  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
}

